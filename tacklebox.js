var p=Object.defineProperty;var w=t=>p(t,"__esModule",{value:!0});var d=(t,e)=>{w(t);for(var n in e)p(t,n,{get:e[n],enumerable:!0})};d(exports,{Abort:()=>b,AllAbort:()=>m,Clear:()=>k,FetchQueue:()=>x,Fork:()=>f,TackleBox:()=>a,tackleSetting:()=>u});var T={threshold:5,maxWorkerNum:3},u=t=>Object.assign({},T,t);var a;(function(e){e.setting=u()})(a||(a={}));var r=[],S=(t,e,n)=>{let o=new AbortController;return e||(e={method:"GET"}),e.signal=o.signal,n=n||0,r.length<1&&(n=f()),r[n].signals[t]=o,new Promise((s,i)=>{C({state:"wait",key:t,job:async l=>{let g=await fetch(t,e);try{l.state="finish",s(g),h()}catch(A){l.state="failed",i(g),h()}delete r[n].signals[t]},args:e},n)})},x=S,b=(t,e)=>{e=e||0;let{running:n,wait:o,signals:s}=r[e];if(!(t in s))return;let i=n.find(c=>c.key===t);if(!i)i.state="cancel",r[e].signals[t].abort();else{let c=o.findIndex(g=>g.key===t);if(c<0)return;let l=o[c];l.state="cancel"}h()},m=()=>{r.forEach(t=>{Object.keys(t.signals).forEach(e=>{t.signals[e].abort()})})},k=()=>{m();let t=r.length;for(let e=0;e<t;e++)r.pop()},f=()=>{if(r.length>=a.setting.maxWorkerNum)throw new Error("worker MAX");let t={wait:[],running:[],signals:{},threshold:a.setting.threshold};return r.push(t)-1},C=(t,e)=>{r[e].wait.push(t),y()},y=()=>{r.forEach(t=>{if(t.running.length>=t.threshold)return;let e=t.wait.shift();!e||t.running.push(e)}),h()},h=()=>{r.forEach(n=>{if(n.running.length<1)return;let o=[];n.running.forEach((s,i)=>{s.state==="wait"&&(s.state="running",s.job(s)),(s.state==="failed"||s.state==="finish"||s.state=="cancel")&&o.push(i)}),n.running=n.running.filter((s,i)=>o.indexOf(i)<0)});let t=!1,e=r.concat();for(;!t&&e.length>0;){let n=e.pop();if(!!n){if(n.running.length>=n.threshold)break;n.wait.length>0&&(t=!0)}}t&&y()};
