var p=Object.defineProperty;var d=t=>p(t,"__esModule",{value:!0});var T=(t,e)=>{d(t);for(var n in e)p(t,n,{get:e[n],enumerable:!0})};T(exports,{Abort:()=>b,AllAbort:()=>m,Clear:()=>k,FetchQueue:()=>x,Fork:()=>f,TackleBox:()=>a,tackleSetting:()=>u});var C={threshold:5,maxWorkerNum:3},u=t=>Object.assign({},C,t);var a;(function(e){e.setting=u()})(a||(a={}));var r=[],A=(t,e,n)=>{let o=new AbortController;return e||(e={method:"GET"}),e.signal=o.signal,n=n||0,r.length<1&&(n=f()),r[n].signals[t]=o,new Promise((s,i)=>{S({state:"wait",key:t,job:async g=>{let c;try{c=await fetch(t,e),g.state="finish",s(c),h()}catch(w){g.state="failed",i(c||w),h()}delete r[n].signals[t]},args:e},n)})},x=A,b=(t,e)=>{e=e||0;let{running:n,wait:o,signals:s}=r[e];if(!(t in s))return!1;let i=n.find(l=>l.key===t);if(i)i.state="cancel",r[e].signals[t].abort();else{let l=o.findIndex(c=>c.key===t);if(l<0)return!1;let g=o[l];g.state="cancel"}return h(),!0},m=()=>{r.forEach(t=>{Object.keys(t.signals).forEach(e=>{t.signals[e].abort()})})},k=()=>{m();let t=r.length;for(let e=0;e<t;e++)r.pop()},f=()=>{if(r.length>=a.setting.maxWorkerNum)throw new Error("worker MAX");let t={wait:[],running:[],signals:{},threshold:a.setting.threshold};return r.length<1&&r.push(Object.assign({},t)),r.push(t)-1},S=(t,e)=>{r[e].wait.push(t),y()},y=()=>{r.forEach(t=>{if(t.running.length>=t.threshold)return;let e=t.wait.shift();!e||t.running.push(e)}),h()},h=()=>{r.forEach(n=>{if(n.running.length<1)return;let o=[];n.running.forEach((s,i)=>{s.state==="wait"&&(s.state="running",s.job(s)),(s.state==="failed"||s.state==="finish"||s.state=="cancel")&&o.push(i)}),n.running=n.running.filter((s,i)=>o.indexOf(i)<0)});let t=!1,e=r.concat();for(;!t&&e.length>0;){let n=e.pop();if(!!n){if(n.running.length>=n.threshold)break;n.wait.length>0&&(t=!0)}}t&&y()};
